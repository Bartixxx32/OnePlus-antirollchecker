name: Check ARB

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Run daily

jobs:
  check-variant:
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        device: [oneplus_15, oneplus_15r, oneplus_13, oneplus_12]
        variant: [GLO, EU, IN, CN]
        exclude:
          - device: oneplus_15r
            variant: CN
        include:
          - device: oneplus_15
            device_short: "15"
            device_name: "OnePlus 15"
          - device: oneplus_15r
            device_short: "15R"
            device_name: "OnePlus 15R"
          - device: oneplus_13
            device_short: "13"
            device_name: "OnePlus 13"
          - device: oneplus_12
            device_short: "12"
            device_name: "OnePlus 12"

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 unzip curl python3-pip
          pip3 install requests beautifulsoup4 --break-system-packages || pip3 install requests beautifulsoup4

      - name: Setup Tools
        run: |
          mkdir -p tools
          
          # Setup arbextract
          curl -L -o tools/arbextract https://github.com/koaaN/arbextract/releases/download/1.0/arbextract-x86_64-linux
          chmod +x tools/arbextract
          
          # Setup payload-dumper-go
          curl -L -o payload-dumper.tar.gz https://github.com/ssut/payload-dumper-go/releases/download/1.3.0/payload-dumper-go_1.3.0_linux_amd64.tar.gz
          tar -xzvf payload-dumper.tar.gz -C tools
          find tools -name "payload-dumper-go" -type f -exec mv {} tools/payload-dumper \;
          chmod +x tools/payload-dumper

      - name: Download Firmware History (INI)
        run: |
          curl -A "Mozilla/5.0" \
            "https://roms.danielspringer.at/download.php?file=Files%2Fota_config.ini&download=true" \
            -o firmware_history.ini

      - name: Get Firmware Details
        id: get_details
        run: |
          DEVICE="${{ matrix.device }}"
          REGION="${{ matrix.variant }}"
          
          # Use oosdownloader for GLO/EU/IN, fetch_firmware.py for CN
          if [ "$REGION" != "CN" ]; then
            # Primary API: oosdownloader
            DOWNLOAD_URL=$(curl -s "https://oosdownloader-gui.fly.dev/api/oneplus/${DEVICE}/${REGION}/full")
            VERSION=$(curl -s "https://oosdownloader-gui.fly.dev/api/oneplus/${DEVICE}/${REGION}/full/version")
          else
            # CN: Use robust scraper
            VERSION=$(python3 parse_ini.py firmware_history.ini "${{ matrix.device_short }}" "CN" | head -n 1 | cut -d'|' -f1)
            DOWNLOAD_URL=$(python3 fetch_firmware.py "${{ matrix.device }}" "CN" "$VERSION")
          fi
          
          echo "Device: ${{ matrix.device_name }}"
          echo "Variant: ${{ matrix.variant }}"
          echo "Latest Firmware URL: $DOWNLOAD_URL"
          echo "Latest Firmware Version: $VERSION"
          
          echo "url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "device_short=${{ matrix.device_short }}" >> $GITHUB_OUTPUT

      - name: Cache ARB Check
        id: cache-arb
        uses: actions/cache@v4
        with:
          path: |
            arb_check_done.txt
            extracted/
          # Cache key includes device and variant to be separate
          key: arb-check-v6-${{ matrix.device }}-${{ matrix.variant }}-${{ steps.get_details.outputs.version }}

      - name: Download Firmware
        if: steps.cache-arb.outputs.cache-hit != 'true'
        run: |
          URL="${{ steps.get_details.outputs.url }}"
          
          if [[ "${{ matrix.variant }}" == "CN" ]]; then
            echo "Downloading CN firmware with single connection & resume logic..."
            # Try up to 10 times, re-fetching URL each time to handle expiration
            for i in {1..10}; do
              if [ $i -gt 1 ]; then
                echo "Attempt $i: Link likely expired. Refreshing signed URL..."
                URL=$(python3 fetch_firmware.py "${{ matrix.device }}" "CN" "${{ steps.get_details.outputs.version }}")
              fi
              
              if [[ "$URL" == *".zip"* ]]; then
                # Use -c to continue, -x1 -s1 for stability on CN servers
                if aria2c -c -x1 -s1 -k1M -o firmware.zip "$URL"; then
                  echo "Download complete!"
                  SUCCESS=true
                  break
                fi
              else
                echo "Invalid URL: $URL"
              fi
              echo "Retrying in 20s..."
              sleep 20
            done
            
            if [ "$SUCCESS" != "true" ]; then
              echo "Failed to download CN firmware after multiple retries."
              touch skip_check.txt
            fi
          elif [[ "$URL" == *".zip"* ]]; then
            echo "Downloading ZIP firmware..."
            aria2c -x16 -s16 -k1M -o firmware.zip "$URL"
          else
            echo "Skipping non-direct download link: $URL"
            touch skip_check.txt
          fi

      - name: Extract xbl_config.img
        if: steps.cache-arb.outputs.cache-hit != 'true' && hashFiles('skip_check.txt') == ''
        run: |
          mkdir -p extracted
          ./tools/payload-dumper -p xbl_config -o extracted firmware.zip
          ls -lh extracted/

      - name: Check ARB
        if: steps.cache-arb.outputs.cache-hit != 'true' && hashFiles('skip_check.txt') == ''
        run: |
          IMG_FILE=$(find extracted -name "*xbl_config*.img" | head -n 1)
          if [ -z "$IMG_FILE" ]; then
            echo "Error: xbl_config image not found!"
            exit 1
          fi
          
          OUTPUT=$(./tools/arbextract "$IMG_FILE")
          ARB_INDEX=$(echo "$OUTPUT" | grep "ARB (Anti-Rollback)" | awk -F': ' '{print $2}')
          MAJOR_VERSION=$(echo "$OUTPUT" | grep "Major Version" | awk -F': ' '{print $2}')
          MINOR_VERSION=$(echo "$OUTPUT" | grep "Minor Version" | awk -F': ' '{print $2}')
          
          echo "ARB Index: $ARB_INDEX"
          
          # Prepare result for artifact
          echo "{" > result.json
          echo "\"device_short\": \"${{ steps.get_details.outputs.device_short }}\"," >> result.json
          echo "\"variant\": \"${{ matrix.variant }}\"," >> result.json
          echo "\"version\": \"${{ steps.get_details.outputs.version }}\"," >> result.json
          echo "\"arb_index\": \"$ARB_INDEX\"," >> result.json
          echo "\"major\": \"$MAJOR_VERSION\"," >> result.json
          echo "\"minor\": \"$MINOR_VERSION\"" >> result.json
          echo "}" >> result.json
          
          cat result.json

      - name: Update JSON History (Current Version)
        if: hashFiles('result.json') != ''
        run: |
          python3 update_history.py \
            "${{ steps.get_details.outputs.device_short }}" \
            "${{ matrix.variant }}" \
            "${{ steps.get_details.outputs.version }}" \
            "$(cat result.json | grep arb_index | cut -d'"' -f4)" \
            "$(cat result.json | grep '\"major\"' | cut -d'"' -f4)" \
            "$(cat result.json | grep '\"minor\"' | cut -d'"' -f4)"


      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.device }}-${{ matrix.variant }}
          path: result.json
      
      - name: Upload JSON History
        uses: actions/upload-artifact@v4
        with:
          name: history-${{ matrix.device }}-${{ matrix.variant }}
          path: data/history/${{ steps.get_details.outputs.device_short }}_${{ matrix.variant }}.json

      - name: Cleanup
        if: always()
        run: rm -f firmware.zip

  update-readme:
    needs: check-variant
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false

      - name: Restore JSON History Files
        run: |
          mkdir -p data/history
          
          # Download all history artifacts
          find artifacts -name 'history-*' -type d | while read dir; do
            JSON_FILE=$(find "$dir" -name '*.json' | head -n 1)
            if [ -f "$JSON_FILE" ]; then
              cp "$JSON_FILE" data/history/
            fi
          done
          
          ls -lh data/history/
      
      - name: Generate README
        run: |
          python3 generate_readme.py
          
          echo "Generated README.md from JSON history"
          head -n 50 README.md

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/history/*.json README.md
          git commit -m "Update ARB history and README" || echo "No changes to commit"
          git push
